//package src.main.java.com.example.filecrypto;
package com.example.filecrypto;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

public class Main {
    private static void printUsage() {
        System.out.println(
        "File Encryption & Decryption Tool (AES-256-GCM)\n" +
        "\n" +
        "Usage:\n" +
        "  Encrypt: java -jar file-crypto-cli.jar encrypt <inputFile> <outputFile> --password \"<password>\"\n" +
        "  Decrypt: java -jar file-crypto-cli.jar decrypt <inputFile> <outputFile> --password \"<password>\"\n" +
        "\n" +
        "Optional flags:\n" +
        "  --salt <hex>   Use a specific salt (hex) instead of generating one (advanced)\n" +
        "\n" +
        "Notes:\n" +
        "  - Output format: [salt|iv|ciphertext|tag] combined in a single file.\n" +
        "  - Keep your password secret; losing it means the data cannot be recovered.\n"
    );
    
}
public static void main(String[] args) {
        if (args.length < 4) {
            printUsage();
            System.exit(1);
        }

        String command = args[0];
        Path input = Paths.get(args[1]);
        Path output = Paths.get(args[2]);

        String password = null;
        byte[] saltOverride = null;

        for (int i = 3; i < args.length; i++) {
            if ("--password".equals(args[i]) && i + 1 < args.length) {
                password = args[++i];
            } else if ("--salt".equals(args[i]) && i + 1 < args.length) {
                saltOverride = CryptoUtils.hexToBytes(args[++i]);
            }
        }

        if (password == null || password.isBlank()) {
            System.err.println("Error: --password is required.");
            printUsage();
            System.exit(1);
        }

        try {
            if (!Files.exists(input)) {
                System.err.println("Error: Input file does not exist: " + input);
                System.exit(1);
            }

            switch (command.toLowerCase()) {
                case "encrypt" -> {
                    byte[] plaintext = Files.readAllBytes(input);

                    byte[] salt = (saltOverride != null) ? saltOverride : KeyUtils.generateSalt(16);
                    byte[] key = KeyUtils.deriveKeyFromPassword(password, salt, 256);

                    CryptoUtils.EncryptionResult result = CryptoUtils.encryptAesGcm(plaintext, key);
                    // File format: [saltLength(1 byte)][salt][ivLength(1 byte)][iv][ciphertext][tag]
                    byte[] packaged = CryptoUtils.packageEncrypted(salt, result.iv(), result.ciphertext(), result.tag());

                    Files.write(output, packaged);
                    System.out.println("Encrypted: " + input + " → " + output);
                }
                case "decrypt" -> {
                    byte[] packaged = Files.readAllBytes(input);
                    CryptoUtils.PackagedData pd = CryptoUtils.unpackageEncrypted(packaged);
                    byte[] key = KeyUtils.deriveKeyFromPassword(password, pd.salt(), 256);
                    byte[] plaintext = CryptoUtils.decryptAesGcm(pd.ciphertext(), key, pd.iv(), pd.tag());

                    Files.write(output, plaintext);
                    System.out.println("Decrypted: " + input + " → " + output);
                }
                default -> {
                    System.err.println("Unknown command: " + command);
                    printUsage();
                    System.exit(1);
                }
            }
        } catch (Exception e) {
            System.err.println("Failure: " + e.getMessage());
            System.exit(2);
        }
    }
}
